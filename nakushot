#!/bin/bash

# Настройки
DEFAULT_EXTENSION="png"
SCREENSHOT_DIR="$HOME/Screenshots/Nakushot"
FILENAME="$(date +"%Y-%m-%d_%H-%M-%S").$DEFAULT_EXTENSION"
NOTIFICATION_TIMEOUT=5000

# Иконки (Nerd Fonts)
ICON_SUCCESS=""
ICON_ERROR=""
ICON_INFO=""
ICON_CLIPBOARD=""
ICON_FOLDER=""

# Создаем директорию для скриншотов
mkdir -p "$SCREENSHOT_DIR"

# Функция показа справки
show_help() {
    echo -e "\033[1;36m${ICON_INFO} Nakushot - утилита для создания скриншотов в Wayland\033[0m"
    echo ""
    echo -e "\033[1mИспользование:\033[0m"
    echo "  nakushot [ПАРАМЕТР]"
    echo ""
    echo -e "\033[1mПараметры:\033[0m"
    echo "  -h, --help      Показать эту справку"
    echo "  -a, --area      Сделать снимок выделенной области"
    echo "  -f, --full      Снимок всего экрана"
    echo "  Без параметров  Открыть интерактивное меню"
    echo ""
    echo -e "\033[1mЗависимости:\033[0m"
    echo "  grim       - захват экрана"
    echo "  slurp      - выделение области"
    echo "  wl-copy    - копирование в буфер Wayland"
    echo "  wofi       - диалоговое меню"
    echo "  libnotify  - уведомления"
}

# Функция отправки уведомлений
send_notification() {
    local summary="$1"
    local body="$2"
    local urgency="${3:-normal}"
    local icon="${4:-}"
    
    notify-send -a "Nakushot" -u "$urgency" -t "$NOTIFICATION_TIMEOUT" \
        -i "$icon" "$summary" "$body"
}


# Функция для создания скриншота области
area_screenshot() {
    local output="$SCREENSHOT_DIR/$FILENAME"
    
    # Получаем координаты области через slurp
    local area
    area=$(slurp -d 2>/dev/null)
    if [ -z "$area" ]; then
        send_notification "${ICON_ERROR} Отменено" "Выделение области отменено" "low" "dialog-error"
        exit 0
    fi
    
    if grim -g "$area" "$output"; then
        wl-copy --type "image/$DEFAULT_EXTENSION" < "$output"
        local file_size
        file_size=$(du -h "$output" | cut -f1)
        
        send_notification "${ICON_SUCCESS} Скриншот области сохранён" \
            "Файл: $(basename "$output")\nРазмер: ${file_size}\nПуть: $SCREENSHOT_DIR" "normal" "camera"
    else
        send_notification "${ICON_ERROR} Ошибка" "Не удалось создать скриншот области" "critical" "camera-error"
        exit 1
    fi
    
    exit 0
}

# Функция для создания скриншота всего экрана
full_screenshot() {
    local output="$SCREENSHOT_DIR/$FILENAME"
    
    send_notification "${ICON_INFO} Создание скриншота" "Захват всего экрана..." "low" "camera-timer"
    
    if grim "$output" && wl-copy --type "image/$DEFAULT_EXTENSION" < "$output"; then
        local file_size
        file_size=$(du -h "$output" | cut -f1)
        local timestamp
        timestamp=$(date +"%d.%m.%Y %H:%M:%S")
        
        send_notification "${ICON_SUCCESS} Скриншот экрана сохранён" \
            "Файл: $(basename "$output")\nРазмер: ${file_size}\nВремя: ${timestamp}" "normal" "camera"
    else
        send_notification "${ICON_ERROR} Ошибка" "Не удалось создать скриншот" "critical" "camera-error"
        exit 1
    fi
    
    exit 0
}

# Функция для обычного скриншота
normal_screenshot() {
    local output="$SCREENSHOT_DIR/$FILENAME"
    
    sleep 0.3  # Небольшая задержка для возможности переключения окон
    
    if grim "$output" && wl-copy --type "image/$DEFAULT_EXTENSION" < "$output"; then
        local file_size
        file_size=$(du -h "$output" | cut -f1)
        
        send_notification "${ICON_SUCCESS} Скриншот сохранён" \
            "Файл: $FILENAME\nРазмер: ${file_size}\nПапка: $SCREENSHOT_DIR" "normal" "camera"
    else
        send_notification "${ICON_ERROR} Ошибка" "Не удалось создать скриншот" "critical" "camera-error"
        exit 1
    fi
}

# Обработка параметров командной строки
case "${1:-}" in
    "--help"|"-h")
        show_help
        exit 0
        ;;
    "--area"|"-a")
        area_screenshot
        ;;
    "--full"|"-f")
        full_screenshot
        ;;
    "")
        # Без параметров - продолжаем к интерактивному меню
        ;;
    *)
        send_notification "${ICON_ERROR} Неизвестный параметр" "Используйте: nakushot --help" "critical" "dialog-error"
        echo "Неизвестный параметр: $1"
        echo "Используйте --help для просмотра справки"
        exit 1
        ;;
esac

# Интерактивное меню
if [ $# -eq 0 ]; then
    choice=$(printf "   Полный экран\n   Выделить область" | \
        wofi --dmenu --prompt "Nakushot" --width 400 --height 90)

    case "$choice" in
        "   Полный экран") 
            normal_screenshot
            ;;
        "   Выделить область") 
            area_screenshot 
            ;;
    esac
fi
